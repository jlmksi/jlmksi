<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÑ∏Í¥ëÍµêÌöå Î∞îÏûêÌöå ÌÇ§Ïò§Ïä§ÌÅ¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f8f8;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #4CAF50;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1em 2em;
            border-radius: 0 0 10px 10px;
            position: relative;
        }
        .container {
            display: flex;
            width: 100%;
        }
        .menu-container {
            flex: 3;
            padding: 1em;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .menu-item {
            background-color: white;
            border: 1px solid #ddd;
            margin: 0.5em;
            padding: 1em;
            width: calc(20% - 1em);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .menu-item button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
        }
        .menu-item p {
            margin: 0.5em 0;
        }
        .edit-button, .delete-button {
            background-color: #4CAF50;
            color: white;
            font-size: 0.8em;
            padding: 0.2em 0.5em;
            margin: 0.2em 0;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .order-summary {
            flex: 1;
            background-color: #fff;
            padding: 1em;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 1em;
            border-radius: 10px;
        }
        .order-summary h2 {
            margin-top: 0;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
        }
        .quantity-controls button {
            margin: 0 0.2em;
        }
        .total-price {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 1em;
        }
        .finalize-order-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 0.5em 1em;
            cursor: pointer;
            margin-top: 1em;
            width: 100%;
            font-size: 1em;
            border-radius: 5px;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
    </script>
</head>
<body>
    <header>
        <h1>ÏÑ∏Í¥ëÍµêÌöå Î∞îÏûêÌöå ÌÇ§Ïò§Ïä§ÌÅ¨</h1>
        <div style="position: absolute; top: 10px; right: 60px;">
            <a href="orders.html" class="manage-link">üìú</a>
        </div>
        <div style="position: absolute; top: 10px; right: 10px;">
            <a href="restaurant.html" class="manage-link">üìã</a>
        </div>
    </header>
    <div class="container">
        <main class="menu-container" id="menuContainer"></main>
        <aside class="order-summary">
            <h2>Ï£ºÎ¨∏ ÌòÑÌô©</h2>
            <ul id="orderList"></ul>
            <div class="total-price" id="totalPrice">Ï¥ù Í∏àÏï°: 0Ïõê</div>
            <button class="finalize-order-button" onclick="finalizeOrder()">Ï£ºÎ¨∏ Í≤∞Ï†ï</button>
        </aside>
    </div>
    <script>
        const menuContainer = document.getElementById('menuContainer');
        const orderList = document.getElementById('orderList');
        const totalPriceElement = document.getElementById('totalPrice');
        let totalPrice = 0;
        const orders = {};
        let menu = JSON.parse(localStorage.getItem('menu')) || [
            { name: 'Î©îÎâ¥1', price: 10000 },
            { name: 'Î©îÎâ¥2', price: 12000 },
            { name: 'Î©îÎâ¥3', price: 15000 }
        ];

        const ws = new WebSocket('wss://restaurant-order-1.onrender.com');

        function formatPrice(price) {
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + 'Ïõê';
        }

        function renderMenu() {
            menuContainer.innerHTML = '';
            menu.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.setAttribute('data-name', item.name);
                menuItem.setAttribute('data-price', item.price);
                menuItem.setAttribute('onclick', `orderItem('${item.name}', ${item.price})`);
                menuItem.innerHTML = `
                    <button>${item.name}</button>
                    <p>${formatPrice(item.price)}</p>
                    <div>
                        <button class="edit-button" onclick="editItem(event, this)">Î©îÎâ¥ ÏàòÏ†ï</button>
                        <button class="delete-button" onclick="deleteMenuItem(event, '${item.name}')">Î©îÎâ¥ ÏÇ≠Ï†ú</button>
                    </div>
                `;
                menuContainer.appendChild(menuItem);
            });
        }

        function orderItem(name, price) {
            if (!orders[name]) {
                orders[name] = { price: price, quantity: 0 };
                addOrderToList(name);
            }
            orders[name].quantity++;
            updateOrderList();
            totalPrice += price;
            updateTotalPrice();
            saveOrders();
        }

        function addOrderToList(name) {
            const listItem = document.createElement('li');
            listItem.id = `order-${name}`;
            listItem.innerHTML = `
                <span>${name} - ${formatPrice(orders[name].price)}</span>
                <div class="quantity-controls">
                    <button class="delete-button" onclick="deleteItem('${name}')">ÏßÄÏö∞Í∏∞</button>
                    <button onclick="updateQuantity('${name}', -1)">-</button>
                    <span id="quantity-${name}">0</span>
                    <button onclick="updateQuantity('${name}', 1)">+</button>
                </div>
            `;
            orderList.appendChild(listItem);
        }

        function updateQuantity(name, change) {
            const newQuantity = orders[name].quantity + change;
            if (newQuantity >= 0) {
                totalPrice += orders[name].price * change;
                orders[name].quantity = newQuantity;
                document.getElementById(`quantity-${name}`).textContent = newQuantity;
                if (newQuantity === 0) {
                    document.getElementById(`order-${name}`).remove();
                    delete orders[name];
                }
                updateTotalPrice();
                saveOrders();
            }
        }

        function deleteItem(name) {
            totalPrice -= orders[name].price * orders[name].quantity;
            document.getElementById(`order-${name}`).remove();
            delete orders[name];
            updateTotalPrice();
            saveOrders();
        }

        function updateOrderList() {
            for (const name in orders) {
                document.getElementById(`quantity-${name}`).textContent = orders[name].quantity;
            }
        }

        function updateTotalPrice() {
            totalPriceElement.textContent = `Ï¥ù Í∏àÏï°: ${formatPrice(totalPrice)}`;
        }

        function editItem(event, button) {
            event.stopPropagation();
            const menuItem = button.parentElement.parentElement;
            const name = menuItem.getAttribute('data-name');
            const price = menuItem.getAttribute('data-price');
            const newName = prompt('ÏÉàÎ°úÏö¥ Î©îÎâ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', name);
            const newPrice = prompt('ÏÉàÎ°úÏö¥ Í∞ÄÍ≤©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', price);

            if (newName && newPrice) {
                menuItem.setAttribute('data-name', newName);
                menuItem.setAttribute('data-price', newPrice);
                menuItem.querySelector('button').textContent = newName;
                menuItem.querySelector('p').textContent = formatPrice(newPrice);
                menuItem.setAttribute('onclick', `orderItem('${newName}', ${newPrice})`);

                const index = menu.findIndex(item => item.name === name);
                menu[index] = { name: newName, price: parseInt(newPrice) };
                saveMenu();
            }
        }

        function deleteMenuItem(event, name) {
            event.stopPropagation();
            if (confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                const index = menu.findIndex(item => item.name === name);
                menu.splice(index, 1);
                renderMenu();
                saveMenu();
            }
        }

        function addMenuItem() {
            const newName = prompt('ÏÉàÎ°úÏö¥ Î©îÎâ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            const newPrice = prompt('ÏÉàÎ°úÏö¥ Í∞ÄÍ≤©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (newName && newPrice) {
                menu.push({ name: newName, price: parseInt(newPrice) });
                renderMenu();
                saveMenu();
            }
        }

        function saveMenu() {
            localStorage.setItem('menu', JSON.stringify(menu));
            alert('Î©îÎâ¥Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
        }

        function saveOrders() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        function finalizeOrder() {
            const tableNumber = prompt('ÌÖåÏù¥Î∏î Î≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (tableNumber) {
                let orderSummary = `ÌÖåÏù¥Î∏î Î≤àÌò∏: ${tableNumber}\n\n`;
                let totalQuantity = 0;
                for (const name in orders) {
                    orderSummary += `${name}: ${orders[name].quantity}Í∞ú\n`;
                    totalQuantity += orders[name].quantity;
                }
                orderSummary += `\nÏ¥ù Í∏àÏï°: ${formatPrice(totalPrice)}`;
                const confirmOrder = confirm(`${orderSummary}\n\nÏ£ºÎ¨∏ÏùÑ ÏôÑÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?`);
                if (confirmOrder) {
                    alert('Ï£ºÎ¨∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§');
                    saveOrder(tableNumber, orders, totalPrice);
                    ws.send(JSON.stringify({ tableNumber, orders, totalPrice })); // Send order to WebSocket server
                    location.reload(); // Reset the page after order is completed
                }
            }
        }

        function saveOrder(tableNumber, orders, totalPrice) {
            const savedOrders = JSON.parse(localStorage.getItem('savedOrders')) || [];
            savedOrders.push({ tableNumber, orders, totalPrice });
            localStorage.setItem('savedOrders', JSON.stringify(savedOrders));
        }

        // Add this function to send the saved orders to the WebSocket server on load
        function sendSavedOrders() {
            const savedOrders = JSON.parse(localStorage.getItem('savedOrders')) || [];
            savedOrders.forEach(order => {
                ws.send(JSON.stringify(order));
            });
        }

        // Call the function to send saved orders on page load
        ws.onopen = function() {
            sendSavedOrders();
        };

        renderMenu();
    </script>
</body>
</html>
